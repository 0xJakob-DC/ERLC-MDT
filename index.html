<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ERLC MDT</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .notif-button-wrapper {
      position: relative;
      display: inline-block;
    }

    .notif-dot {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      display: none;
    }

    .notif-button-wrapper.has-unread .notif-dot {
      display: block;
    }

    .invite-entry {
      margin-bottom: 10px;
      background-color: #003366;
      padding: 10px;
      border-radius: 5px;
    }

    .invite-entry button {
      margin-top: 5px;
      background-color: #28a745;
      color: white;
    }
  </style>
</head>
<body>
  <div class="background">
    <div class="tablet">
      <div id="login-screen">
        <h2>MDT Login</h2>
        <input type="text" id="login-username" placeholder="Username" />
        <input type="password" id="login-password" placeholder="Password" />
        <input type="text" id="login-rpname" placeholder="RP Name" />
        <button onclick="login()">Login</button>
      </div>

      <div id="mdt" style="display: none;">
        <div id="menu" class="tab">
          <nav>
            <div class="notif-button-wrapper" id="notif-button">
              <button onclick="showTab('notifications')">Notifications</button>
              <span class="notif-dot"></span>
            </div>
            <button onclick="showTab('settings')">Settings</button>
            <button onclick="showTab('team')">Team</button>
          </nav>
        </div>

        <div id="team" class="tab" style="display: none;">
          <button class="menu-btn" onclick="goToMenu()">Menu</button>
          <h3>Team</h3>
          <div id="team-interface">
            <div id="create-join-team-section">
              <h4>Create Team</h4>
              <input type="text" id="team-name" placeholder="Team Name" />
              <button onclick="createTeam()">Create Team</button>
              <h4>Join Team</h4>
              <input type="text" id="join-code" placeholder="Enter Team Code" />
              <button onclick="joinTeam()">Join Team</button>
            </div>

            <div id="my-team" style="display: none;">
              <h4>Your Team</h4>
              <p><strong>Team Name:</strong> <span id="display-team-name"></span></p>
              <p><strong>Team Code:</strong> <span id="display-team-code"></span></p>
              <input type="text" id="invite-username" placeholder="Username to invite" />
              <button onclick="inviteUser()">Send Invite</button>
              <button onclick="leaveTeam()">Leave Team</button>
              <button onclick="viewReports()">View Incident Reports</button>
              <button onclick="showTab('player-view')">View Players</button>
              <button onclick="showTab('file-report')">Make an Incident Report</button>
            </div>
          </div>
        </div>

        <div id="player-view" class="tab" style="display:none;">
          <button class="menu-btn" onclick="goToMenu()">Menu</button>
          <h3>Team Members</h3>
          <div id="player-management"></div>
        </div>

        <div id="settings" class="tab" style="display:none;">
          <button class="menu-btn" onclick="goToMenu()">Menu</button>
          <h3>Settings</h3>
          <p><strong>Username:</strong> <span id="show-username"></span></p>
          <p><strong>RP Name:</strong> <span id="show-rpname"></span></p>
          <button onclick="logout()">Logout</button>
        </div>

        <div id="notifications" class="tab" style="display:none;">
          <button class="menu-btn" onclick="goToMenu()">Menu</button>
          <h3>Notifications</h3>
          <button onclick="clearNotifications()">Clear Notifications</button>
          <ul id="notification-list"></ul>
        </div>

        <div id="file-report" class="tab" style="display:none;">
          <button class="menu-btn" onclick="goToMenu()">Menu</button>
          <h3>File Incident Report</h3>
          <input type="text" id="report-name" placeholder="Incident Name" />
          <input type="text" id="report-user" placeholder="Name (Username)" />
          <input type="text" id="report-date" placeholder="Date" />
          <input type="text" id="report-age" placeholder="Age" />
          <input type="text" id="report-gender" placeholder="Gender" />
          <textarea id="report-description" placeholder="Incident Report..."></textarea>
          <button onclick="fileReport()">Submit Report</button>
        </div>

        <div id="incident-reports" class="tab" style="display:none;">
          <button class="menu-btn" onclick="goToMenu()">Menu</button>
          <h3>Incident Reports</h3>
          <ul id="report-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    let teamData = JSON.parse(localStorage.getItem('teamData')) || {};
    let reports = JSON.parse(localStorage.getItem('reports')) || [];
    let currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};

    function saveData() {
      localStorage.setItem('teamData', JSON.stringify(teamData));
      localStorage.setItem('reports', JSON.stringify(reports));
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
    }

    function getUserNotifications(username) {
      return JSON.parse(localStorage.getItem('notifications_' + username)) || [];
    }

    function saveUserNotifications(username, notifs) {
      localStorage.setItem('notifications_' + username, JSON.stringify(notifs));
    }

    function login() {
      const user = document.getElementById("login-username").value;
      const pass = document.getElementById("login-password").value;
      const rpname = document.getElementById("login-rpname").value;
      if (user && pass && rpname) {
        currentUser = { username: user, rpname: rpname };
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("mdt").style.display = "block";
        document.getElementById("show-username").textContent = user;
        document.getElementById("show-rpname").textContent = rpname;
        updateTeamDisplay();
        showTab('menu');
        saveData();
        showNotifications();
      } else {
        alert("Please fill in all fields.");
      }
    }

    function logout() {
      document.getElementById("mdt").style.display = "none";
      document.getElementById("login-screen").style.display = "block";
      currentUser = {};
      saveData();
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
      if (tabId === 'player-view') showPlayerManagement();
      if (tabId === 'notifications') showNotifications();
    }

    function goToMenu() {
      showTab('menu');
    }

    function createTeam() {
      const name = document.getElementById("team-name").value;
      const code = Math.random().toString(36).substring(2, 8).toUpperCase();
      const team = {
        name,
        code,
        members: {
          [currentUser.username]: currentUser
        }
      };
      teamData[code] = team;
      currentUser.teamCode = code;
      updateTeamDisplay();
      saveData();
      alert("Team created!");
    }

    function joinTeam() {
      const code = document.getElementById("join-code").value.toUpperCase();
      const team = teamData[code];
      if (team) {
        team.members[currentUser.username] = currentUser;
        currentUser.teamCode = code;
        updateTeamDisplay();
        saveData();
        alert("Joined team!");
      } else {
        alert("Team code not found.");
      }
    }

    function leaveTeam() {
      const code = currentUser.teamCode;
      if (code && teamData[code]?.members[currentUser.username]) {
        delete teamData[code].members[currentUser.username];
        currentUser.teamCode = null;
        updateTeamDisplay();
        saveData();
      }
    }

    function updateTeamDisplay() {
      const code = currentUser.teamCode;
      const team = teamData[code];
      if (team && team.members[currentUser.username]) {
        document.getElementById("my-team").style.display = "block";
        document.getElementById("create-join-team-section").style.display = "none";
        document.getElementById("display-team-name").textContent = team.name;
        document.getElementById("display-team-code").textContent = team.code;
      } else {
        document.getElementById("my-team").style.display = "none";
        document.getElementById("create-join-team-section").style.display = "block";
      }
    }

    function inviteUser() {
      const username = document.getElementById("invite-username").value;
      const code = currentUser.teamCode;
      if (username && code) {
        const notifs = getUserNotifications(username);
        notifs.push({
          type: "invite",
          message: `${currentUser.username} invited you to join their team.`,
          code: code
        });
        saveUserNotifications(username, notifs);
        alert("Invitation sent!");
      }
    }

    function showNotifications() {
      const notifList = document.getElementById("notification-list");
      const notifs = getUserNotifications(currentUser.username);
      notifList.innerHTML = "";

      const hasUnread = notifs.length > 0;
      const notifBtn = document.getElementById("notif-button");
      notifBtn.classList.toggle("has-unread", hasUnread);

      notifs.forEach((notif, i) => {
        const li = document.createElement("li");
        if (notif.type === "invite") {
          li.className = "invite-entry";
          li.innerHTML = `
            <p>${notif.message}</p>
            <button onclick="acceptInvite('${notif.code}', ${i})">Join</button>
          `;
        } else {
          li.textContent = notif.message || notif;
        }
        notifList.appendChild(li);
      });
    }

    function acceptInvite(code, index) {
      const team = teamData[code];
      if (team) {
        team.members[currentUser.username] = currentUser;
        currentUser.teamCode = code;
        updateTeamDisplay();
        saveData();
        let notifs = getUserNotifications(currentUser.username);
        notifs.splice(index, 1);
        saveUserNotifications(currentUser.username, notifs);
        showNotifications();
        alert("You joined the team!");
        goToMenu();
      } else {
        alert("Team no longer exists.");
      }
    }

    function clearNotifications() {
      localStorage.removeItem('notifications_' + currentUser.username);
      showNotifications();
    }

    function showPlayerManagement() {
      const code = currentUser.teamCode;
      const team = teamData[code];
      const container = document.getElementById("player-management");
      container.innerHTML = "";
      for (let member in team.members) {
        const rp = team.members[member].rpname;
        container.innerHTML += `<p>${member} / ${rp}</p>`;
      }
    }

    function fileReport() {
      const name = document.getElementById("report-name").value;
      const user = document.getElementById("report-user").value;
      const date = document.getElementById("report-date").value;
      const age = document.getElementById("report-age").value;
      const gender = document.getElementById("report-gender").value;
      const desc = document.getElementById("report-description").value;
      reports.push({ name, user, date, age, gender, desc });
      saveData();
      alert("Incident report logged");
      goToMenu();
    }

    function viewReports() {
      const list = document.getElementById("report-list");
      list.innerHTML = "";
      reports.forEach(report => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${report.name}</strong><br>User: ${report.user}<br>Date: ${report.date}<br>Age: ${report.age}<br>Gender: ${report.gender}<br>${report.desc}`;
        list.appendChild(li);
      });
      showTab("incident-reports");
    }
  </script>
</body>
</html>